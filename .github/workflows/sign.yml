name: Auto Sign IPA

on:
  workflow_dispatch:

jobs:
  sign:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y git make g++ libzip-dev libplist-dev openssl

      - name: Build ZSign
        run: |
          git clone https://github.com/zhlynn/zsign.git
          cd zsign && make
          sudo cp zsign /usr/local/bin/zsign

      - name: Restore cert files
        run: |
          echo "$P12_BASE64" | base64 -d > cert.p12
          echo "$PROV_BASE64" | base64 -d > profile.mobileprovision
        env:
          P12_BASE64: ${{ secrets.P12_BASE64 }}
          PROV_BASE64: ${{ secrets.PROV_BASE64 }}

      - name: Find IPA
        run: |
          IPA_FILE=$(find . -name "*.ipa" | head -1)
          echo "IPA_FILE=$IPA_FILE" >> $GITHUB_ENV

      - name: Sign IPA
        run: |
          zsign -k cert.p12 -p "$P12_PASSWORD" -m profile.mobileprovision -o signed_app.ipa "$IPA_FILE"
        env:
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}

      - uses: actions/upload-artifact@v4
        with:
          name: signed-ipa
          path: signed_app.ipa
